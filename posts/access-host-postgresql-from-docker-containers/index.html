<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=format-detection content="telephone=no"><title>Access Host PostgreSQL from Docker Containers | guoqiao's personal website</title><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/manifest.json><link rel=mask-icon href=/safari-pinned-tab.svg color=#ff3db4><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://guoqiao.me/css/main.min.975b1911c008aee6ab5fb42e51274b8268ebcb65dc15bd4a5f69b9eedb485c3e.css></head><body><nav><header><div class=site-title><a href=/>guoqiao's personal website</a></div></header><div class=nav-menu><a class="color-link nav-link" href=https://guoqiao.me/index.xml target=_blank rel=noopener type=application/rss+xml>RSS</a></div><footer class=footer><div class=social-icons><a class=social-icon href=https://twitter.com/guoqiao target=_blank rel=noopener title=Twitter><svg width="28" height="28" viewBox="0 0 28 28" fill="#ababab" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink"><path d="M8.991284 24.971612c10.189152.0 15.761088-8.441388 15.761088-15.761088C24.752372 8.970656 24.747512 8.731868 24.736496 8.494376 25.818008 7.712564 26.758256 6.737 27.5 5.62622c-.992628.440856-2.060748.738072-3.181248.871992 1.14372-.685584 2.02176-1.770768 2.435832-3.064176-1.070496.6345-2.25558 1.095984-3.517344 1.344492-1.010772-1.076652-2.450412-1.75014-4.043412-1.75014-3.059424.0-5.540292 2.480868-5.540292 5.539104.0.434808.0487079999999995.857412.14364 1.26306C9.19346 9.599108 5.11106 7.39472 2.3792 4.04294c-.476172.818424-.750168 1.769688-.750168 2.784132.0 1.921968.97794 3.61854 2.464992 4.61106C3.185528 11.41016 2.331788 11.160464 1.585184 10.745096 1.583888 10.768208 1.583888 10.791428 1.583888 10.815728c0 2.683152 1.909764 4.922856 4.4442 5.43078C5.562932 16.373084 5.07326 16.44134 4.56782 16.44134 4.210988 16.44134 3.863876 16.406024 3.526484 16.34144c.70524 2.200824 2.750112 3.802356 5.174928 3.8475-1.896264 1.485756-4.284576 2.37114-6.879924 2.37114C1.374476 22.56008.93362 22.534592.5 22.4834c2.451708 1.571076 5.362524 2.488212 8.491284 2.488212"/></svg></a><a class=social-icon href=https://github.com/guoqiao target=_blank rel=noopener title=GitHub><svg width="28" height="28" viewBox="0 0 28 28" fill="#ababab" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink"><path d="M13.9988029 1.32087331C6.82105037 1.32087331 1 7.14112562 1 14.3212723c0 5.7436386 3.72454649 10.6157955 8.89038951 12.3348169C10.5408085 26.7757983 10.7778323 26.374374 10.7778323 26.0296121 10.7778323 25.7215609 10.7666595 24.9035493 10.760275 23.8189856 7.14426471 24.6042767 6.38131925 22.0760223 6.38131925 22.0760223c-.59136253-1.5019491-1.44369072-1.9017772-1.44369072-1.9017772C3.75729765 19.3682044 5.02701126 19.3841656 5.02701126 19.3841656 6.33183953 19.4759425 7.01817121 20.7241085 7.01817121 20.7241085c1.15958133 1.9863716 3.04300319 1.4125664 3.78360289 1.0797753.1181129-.8395592.4540962-1.4125663.8251942-1.7373768C8.74038491 19.7385043 5.70536235 18.6228163 5.70536235 13.6413251c0-1.4189508.50676816-2.5801283 1.33834679-3.4883207C6.90963504 9.82420367 6.46351945 8.50181809 7.17139875 6.71256734c0 0 1.09094816-.34955032 3.57451115 1.33276037C11.78259 7.75642995 12.8950858 7.61277914 14.000399 7.60719272 15.1049142 7.61277914 16.2166119 7.75642995 17.2548881 8.04532771c2.4819669-1.68231069 3.571319-1.33276037 3.571319-1.33276037C21.5356825 8.50181809 21.0895669 9.82420367 20.9562909 10.1530044 21.7894656 11.0611968 22.2922435 12.2223743 22.2922435 13.6413251c0 4.9942601-3.039811 6.0931889-5.935173 6.4148071.4660671.401424200000001.8818564 1.194696.8818564 2.4077473C17.2389269 24.2012564 17.2229657 25.603448 17.2229657 26.0296121 17.2229657 26.3775663 17.4575954 26.7821827 18.116793 26.6552912 23.2786458 24.9322794 27 20.0633148 27 14.3212723 27 7.14112562 21.1789496 1.32087331 13.9988029 1.32087331"/></svg></a></div><p><a href=https://github.com/kimcc/hugo-theme-noteworthy target=_blank rel=noopener>Noteworthy theme</a></p><p><a href=https://gohugo.io target=_blank rel=noopener>Built with Hugo</a></p><script src=https://guoqiao.me/js/main.min.a7205ef73b078c8daed6fe1b0826e8ba229ffabbb69d299d9446cf41f2c7d8aa.js integrity="sha256-pyBe9zsHjI2u1v4bCCbouiKf+ru2nSmdlEbPQfLH2Ko=" crossorigin=anonymous></script></footer></nav><div id=content class=content-container><h1 class=post-title>Access Host PostgreSQL from Docker Containers</h1><time>February 6, 2022</time><div><p><p>It&rsquo;s common that service in docker container needs a database, such as PostgreSQL.</p><p>You can also run database in another docker container and link them together. However, there are reasons not to do that in some senarios.:</p><ul><li>cpu/ram resources are limited, e.g on NAS, so you may perfer to re-use the database service.</li><li>normally 1 database container can only connect to 1 service, you will need extra effort to allow multiple docker services to connect same database container.</li><li>database is important, putting it in docker container will add extra knowledage requirements to manage it properly, such as backup, migration, optimizing, etc.</li><li>although docker container is fast and light-weight, there will still be performance loss.</li></ul><p>Here we show how you can make multiple docker containers connect to the same external PostgreSQL database on docker host machine.</p><h2 id=config-postgresql-to-allow-access-from-docker-containers>Config PostgreSQL to allow access from Docker containers</h2><p>ssh to nas, make following change:</p><pre tabindex=0><code># sudo vim /etc/postgresql/postgresql.conf

# listen_address = &#34;127.0.0.1&#34;
listen_address = &#34;0.0.0.0&#34;
</code></pre><p>This will allow PostgreSQL to listen on any IP address, other than localhost only.</p><p>Now you still need to allow access from docker containers:</p><pre tabindex=0><code># sudo vim /etc/postgresql/pg_hba.conf

# allow connections from docker containers without checking password
host    all             postgres             172.16.0.0/12           trust
# or require password
host    all             postgres             172.16.0.0/12           md5
</code></pre><p>Each docker container will use a gateway IP to communicate with host machine. You can get geteway IP with:</p><pre tabindex=0><code>docker inspect &lt;contrainer&gt; | grep Gateway
</code></pre><p>If you have multiple docker containers, you may noticed that the gateway IP varies. However, they are all in CIDR <code>172.16.0.0/12</code>, which is reserved private IP range.</p><p>Here, to simplify things for demo purpose, I just use <code>trust</code> method to allow all connections from this CIDR, with the builtin <code>postgres</code> user. Which means, on my NAS, any docker containers can connect to PostgreSQL without password. Obvious this is not secure.</p><p>To make above changes take effect, you need to restart PostgreSQL service:</p><pre tabindex=0><code># on NAS:
sudo su - postgres
pg_ctl -m fast restart
# or on Ubuntu:
# sudo systemctl restart postgresql
</code></pre><h2 id=config-docker-container-to-connect-to-postgresql-on-docker-host-machine>Config Docker container to connect to PostgreSQL on docker host machine</h2><p>Here is an example <code>docker-compose.yml</code> file for <code>Nextcloud</code>(on Ubuntu, not for NAS):</p><pre tabindex=0><code>───────┬──────────────────────────────────────────────────────────────────────────────
       │ File: docker-compose.yaml
───────┼──────────────────────────────────────────────────────────────────────────────
   1   │ version: &#34;3&#34;
   2   │
   3   │ # https://github.com/nextcloud/docker#running-this-image-with-docker-compose
   4   │
   5   │ volumes:
   6   │   nextcloud:
   7   │
   8   │ services:
   9   │   nextcloud:
  10   │     image: nextcloud
  11   │     restart: always
  12   │     ports:
  13   │       - &#34;8090:80&#34;
  14   │     volumes:
  15   │       - nextcloud:/var/www/html
  16   │     extra_hosts:
  17   │       - &#34;host.docker.internal:host-gateway&#34;
  18   │     environment:
  19   │       # must provide all 4 postgres envvars
  20   │       - POSTGRES_HOST=host.docker.internal
  21   │       - POSTGRES_DB=${POSTGRES_DB}
  22   │       - POSTGRES_USER=${POSTGRES_USER}
  23   │       - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
  24   │       # redis
  25   │       - REDIS_HOST=host.docker.internal
  26   │       - REDIS_HOST_PORT=6379
  27   │       # admin user
  28   │       - NEXTCLOUD_ADMIN_USER=${ADMIN_USERNAME}
  29   │       - NEXTCLOUD_ADMIN_PASSWORD=${ADMIN_PASSWORD}
  30   │       - NEXTCLOUD_TRUSTED_DOMAINS=${NEXTCLOUD_TRUSTED_DOMAINS}
───────┴──────────────────────────────────────────────────────────────────────────────
</code></pre><p>Please note:</p><ul><li>Not only PostgreSQL, I also connect to Redis Server on docker host.</li><li>docker-compose can read envvars form <code>./.env</code> file.</li></ul><p>The key here is to add <code>host.docker.internal:host-gateway</code> as <code>extra_hosts</code>, and use <code>host.docker.internal</code> as domain name for docker host.</p><h2 id=summary>Summary</h2><p>With this setup, you can run multiple docker containers with shared services on docker host.
This is useful for personal server, or home/office network.</p><h2 id=issue-on-nas>Issue on NAS</h2><p>My original goal for this topic is to use builtin PostgreSQL on Synology NAS for docker containers.
However, I noticed the <code>docker</code> package has no way to add extra_hosts, so I have to use gateway IP to connect to PostgreSQL for now, which is working but not reliable.</p></p></div><div class=page-footer><hr class=footer-divider><a class=tag href=/tags/docker>#Docker</a>
<a class=tag href=/tags/docker-compose>#Docker-Compose</a>
<a class=tag href=/tags/postgresql>#PostgreSQL</a></div></div><footer class=footer-mobile><div class=social-icons><a class=social-icon href=https://twitter.com/guoqiao target=_blank rel=noopener title=Twitter><svg width="28" height="28" viewBox="0 0 28 28" fill="#ababab" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink"><path d="M8.991284 24.971612c10.189152.0 15.761088-8.441388 15.761088-15.761088C24.752372 8.970656 24.747512 8.731868 24.736496 8.494376 25.818008 7.712564 26.758256 6.737 27.5 5.62622c-.992628.440856-2.060748.738072-3.181248.871992 1.14372-.685584 2.02176-1.770768 2.435832-3.064176-1.070496.6345-2.25558 1.095984-3.517344 1.344492-1.010772-1.076652-2.450412-1.75014-4.043412-1.75014-3.059424.0-5.540292 2.480868-5.540292 5.539104.0.434808.0487079999999995.857412.14364 1.26306C9.19346 9.599108 5.11106 7.39472 2.3792 4.04294c-.476172.818424-.750168 1.769688-.750168 2.784132.0 1.921968.97794 3.61854 2.464992 4.61106C3.185528 11.41016 2.331788 11.160464 1.585184 10.745096 1.583888 10.768208 1.583888 10.791428 1.583888 10.815728c0 2.683152 1.909764 4.922856 4.4442 5.43078C5.562932 16.373084 5.07326 16.44134 4.56782 16.44134 4.210988 16.44134 3.863876 16.406024 3.526484 16.34144c.70524 2.200824 2.750112 3.802356 5.174928 3.8475-1.896264 1.485756-4.284576 2.37114-6.879924 2.37114C1.374476 22.56008.93362 22.534592.5 22.4834c2.451708 1.571076 5.362524 2.488212 8.491284 2.488212"/></svg></a><a class=social-icon href=https://github.com/guoqiao target=_blank rel=noopener title=GitHub><svg width="28" height="28" viewBox="0 0 28 28" fill="#ababab" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink"><path d="M13.9988029 1.32087331C6.82105037 1.32087331 1 7.14112562 1 14.3212723c0 5.7436386 3.72454649 10.6157955 8.89038951 12.3348169C10.5408085 26.7757983 10.7778323 26.374374 10.7778323 26.0296121 10.7778323 25.7215609 10.7666595 24.9035493 10.760275 23.8189856 7.14426471 24.6042767 6.38131925 22.0760223 6.38131925 22.0760223c-.59136253-1.5019491-1.44369072-1.9017772-1.44369072-1.9017772C3.75729765 19.3682044 5.02701126 19.3841656 5.02701126 19.3841656 6.33183953 19.4759425 7.01817121 20.7241085 7.01817121 20.7241085c1.15958133 1.9863716 3.04300319 1.4125664 3.78360289 1.0797753.1181129-.8395592.4540962-1.4125663.8251942-1.7373768C8.74038491 19.7385043 5.70536235 18.6228163 5.70536235 13.6413251c0-1.4189508.50676816-2.5801283 1.33834679-3.4883207C6.90963504 9.82420367 6.46351945 8.50181809 7.17139875 6.71256734c0 0 1.09094816-.34955032 3.57451115 1.33276037C11.78259 7.75642995 12.8950858 7.61277914 14.000399 7.60719272 15.1049142 7.61277914 16.2166119 7.75642995 17.2548881 8.04532771c2.4819669-1.68231069 3.571319-1.33276037 3.571319-1.33276037C21.5356825 8.50181809 21.0895669 9.82420367 20.9562909 10.1530044 21.7894656 11.0611968 22.2922435 12.2223743 22.2922435 13.6413251c0 4.9942601-3.039811 6.0931889-5.935173 6.4148071.4660671.401424200000001.8818564 1.194696.8818564 2.4077473C17.2389269 24.2012564 17.2229657 25.603448 17.2229657 26.0296121 17.2229657 26.3775663 17.4575954 26.7821827 18.116793 26.6552912 23.2786458 24.9322794 27 20.0633148 27 14.3212723 27 7.14112562 21.1789496 1.32087331 13.9988029 1.32087331"/></svg></a></div><div class=footer-mobile-links><p><a href=https://github.com/kimcc/hugo-theme-noteworthy target=_blank rel=noopener>Noteworthy theme</a></p><span class=divider-bar>|</span><p><a href=https://gohugo.io target=_blank rel=noopener>Built with Hugo</a></p></div><script src=https://guoqiao.me/js/main.min.a7205ef73b078c8daed6fe1b0826e8ba229ffabbb69d299d9446cf41f2c7d8aa.js integrity="sha256-pyBe9zsHjI2u1v4bCCbouiKf+ru2nSmdlEbPQfLH2Ko=" crossorigin=anonymous></script></footer></body></html>